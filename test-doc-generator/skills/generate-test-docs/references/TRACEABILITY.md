# 需求追溯矩阵

本文档定义需求-用例追溯矩阵的结构、生成规则和覆盖率计算方法。

---

## 追溯矩阵概述

### 目的

1. **双向追溯**：从需求找用例，从用例找需求
2. **覆盖验证**：确保每个需求都有测试用例覆盖
3. **变更影响**：需求变更时快速定位受影响的用例
4. **遗漏检测**：发现未覆盖的需求和孤儿用例

---

## 追溯矩阵结构

### 正向追溯（需求 → 用例）

生成一个独立的 Excel Sheet 或 Markdown 表格：

| 需求ID | 需求名称 | 验收条件数 | 用例ID列表 | 用例数量 | 覆盖状态 |
|--------|---------|-----------|-----------|---------|---------|
| REQ_001 | 用户登录功能 | 3 | TC_001, TC_002, TC_003, TC_004, TC_005 | 5 | ✅ 已覆盖 |
| REQ_002 | 密码找回功能 | 2 | TC_010, TC_011 | 2 | ✅ 已覆盖 |
| REQ_003 | 第三方登录 | 2 | - | 0 | ❌ 未覆盖 |

### 反向追溯（用例 → 需求）

在测试用例 Excel 中增加「关联需求」列：

| 用例ID | 用例标题 | 关联需求ID | 需求名称 |
|--------|---------|-----------|---------|
| TC_001 | 正确账号密码登录 | REQ_001 | 用户登录功能 |
| TC_002 | 密码错误登录失败 | REQ_001 | 用户登录功能 |
| TC_099 | 某历史遗留用例 | - | ⚠️ 孤儿用例 |

---

## 需求ID提取规则

### 自动识别模式

从需求文档中自动识别需求标识：

| 模式 | 正则表达式 | 示例 |
|------|-----------|------|
| 标准编号 | `REQ[-_]?\d+` | REQ_001, REQ-123 |
| 功能编号 | `F[-_]?\d+(\.\d+)*` | F1.2, F-3.1.2 |
| 用户故事 | `US[-_]?\d+` | US_042 |
| 需求章节 | `^\d+(\.\d+)*\s` | 3.2.1 用户登录 |
| JIRA格式 | `[A-Z]+-\d+` | PROJ-123 |

### 手动标记

如果需求文档无明确编号，Claude 应：
1. 按功能模块自动生成：`MOD_功能名_序号`
2. 示例：`MOD_LOGIN_001`（登录模块第1个需求）

### 需求层级

```
模块 (Module)
  └── 功能 (Feature)
        └── 需求点 (Requirement)
              └── 验收条件 (Acceptance Criteria)
```

追溯到**需求点**级别，验收条件体现在用例步骤中。

---

## 覆盖率计算

### 需求覆盖率

```
需求覆盖率 = 已覆盖需求数 / 总需求数 × 100%
```

**计算规则**：
- 需求至少有1条用例关联，即视为"已覆盖"
- 建议覆盖率目标：≥95%

**示例**：
```
总需求数：20
已覆盖：18
未覆盖：2
覆盖率：90%
```

### 覆盖深度

```
覆盖深度 = 总用例数 / 总需求数
```

**参考标准**：
| 模块风险等级 | 建议覆盖深度 |
|-------------|-------------|
| 核心/高风险 | ≥5 用例/需求 |
| 一般功能 | 3-5 用例/需求 |
| 边缘功能 | 1-3 用例/需求 |

### 验收条件覆盖率

```
验收覆盖率 = 已覆盖验收条件数 / 总验收条件数 × 100%
```

每个验收条件应至少有1条正向用例验证。

---

## 遗漏检测

### 未覆盖需求检测

**检测逻辑**：
1. 遍历需求列表
2. 对每个需求ID，查找关联的用例
3. 若用例数为0，标记为「未覆盖」

**输出格式**：

```markdown
## 未覆盖需求清单

| 需求ID | 需求名称 | 风险等级 | 建议操作 |
|--------|---------|---------|---------|
| REQ_003 | 第三方登录 | 高 | 需补充用例 |
| REQ_015 | 消息推送 | 中 | 需补充用例 |

未覆盖需求数：2
总需求数：20
覆盖缺口：10%
```

### 孤儿用例检测

**定义**：无关联需求ID的用例

**检测逻辑**：
1. 遍历用例列表
2. 检查「关联需求ID」列
3. 若为空或无效ID，标记为「孤儿用例」

**处理建议**：
- 尝试匹配需求（可能是遗漏标记）
- 若确实无对应需求，考虑删除或归档

---

## 追溯矩阵生成流程

### Phase 1: 解析需求文档

```
输入：需求文档（PDF/Word/Markdown）
输出：需求列表
```

1. 使用 `extract_document.py` 提取文本
2. 按照「需求ID提取规则」识别需求
3. 提取每个需求的：
   - 需求ID
   - 需求名称/标题
   - 验收条件（如有）
   - 所属模块

### Phase 2: 生成用例并关联

```
输入：需求列表、测试设计方法
输出：带关联的测试用例
```

1. 对每个需求生成用例
2. 每个用例记录来源需求ID
3. 存入 Excel「关联需求ID」列

### Phase 3: 生成追溯矩阵

```
输入：需求列表、用例列表
输出：追溯矩阵表
```

1. 汇总需求-用例对应关系
2. 计算覆盖率指标
3. 标记遗漏项

---

## Excel 输出规范

### 追溯矩阵 Sheet

**Sheet 名称**：`需求追溯矩阵`

**列定义**：

| 列名 | 说明 | 示例 |
|------|------|------|
| 需求ID | 需求唯一标识 | REQ_001 |
| 需求名称 | 需求简短描述 | 用户登录功能 |
| 所属模块 | 功能模块 | 用户管理 |
| 验收条件数 | AC数量 | 3 |
| 关联用例 | 用例ID列表（逗号分隔） | TC_001, TC_002, TC_003 |
| 用例数量 | 关联用例总数 | 3 |
| 覆盖状态 | 已覆盖/未覆盖 | ✅ 已覆盖 |
| 备注 | 补充说明 | - |

### 覆盖率统计 Sheet

**Sheet 名称**：`覆盖率统计`

**内容**：

| 统计项 | 数值 |
|--------|------|
| 总需求数 | 20 |
| 已覆盖需求数 | 18 |
| 未覆盖需求数 | 2 |
| 需求覆盖率 | 90% |
| 总用例数 | 85 |
| 覆盖深度 | 4.25 |
| 孤儿用例数 | 1 |

---

## 覆盖检查清单

生成追溯矩阵后，执行以下检查：

- [ ] 每个需求至少有1条正向用例
- [ ] 每个需求的验收条件都有对应用例
- [ ] 核心需求（P0）覆盖深度 ≥5
- [ ] 无孤儿用例
- [ ] 需求覆盖率 ≥95%
- [ ] 高风险模块有错误推测用例补充

---

## Markdown 输出格式

如果输出 Markdown 格式的追溯矩阵：

```markdown
# 需求追溯矩阵

## 覆盖率概览

- 总需求数：20
- 已覆盖：18 (90%)
- 未覆盖：2 (10%)
- 覆盖深度：4.25 用例/需求

## 详细追溯

### REQ_001 用户登录功能

**所属模块**：用户管理
**验收条件**：3个
**覆盖状态**：✅ 已覆盖

关联用例：
- TC_001 正确账号密码登录
- TC_002 密码错误登录失败
- TC_003 账号不存在
- TC_004 验证码登录
- TC_005 记住登录状态

### REQ_003 第三方登录

**所属模块**：用户管理
**验收条件**：2个
**覆盖状态**：❌ 未覆盖

⚠️ 需补充测试用例

## 未覆盖需求

| 需求ID | 需求名称 | 建议操作 |
|--------|---------|---------|
| REQ_003 | 第三方登录 | 补充用例 |
| REQ_015 | 消息推送 | 补充用例 |
```
