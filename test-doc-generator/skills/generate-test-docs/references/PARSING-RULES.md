# 需求解析规则

从需求文档中提取测试场景的规则和模式。

## 需求文档结构识别

### 常见需求文档格式

**格式1：PRD 结构**
```
# 产品需求文档
## 1. 背景
## 2. 功能列表
### 2.1 功能A
### 2.2 功能B
## 3. 非功能需求
```

**格式2：用户故事**
```
作为 <角色>
我想要 <功能>
以便于 <价值>

验收条件：
- AC1
- AC2
```

**格式3：功能说明**
```
## 功能名称
### 功能描述
### 输入
### 输出
### 业务规则
### 异常处理
```

## 关键信息提取

### 1. 功能模块
- 识别一级/二级标题
- 提取模块名称和层级关系

### 2. 功能描述
- 找到功能说明段落
- 提取核心行为描述

### 3. 验收条件
关键词识别：
- "验收条件"、"AC"、"Acceptance Criteria"
- "应该"、"必须"、"需要"
- 编号列表（1. 2. 3. 或 - ）

### 4. 业务规则
关键词识别：
- "规则"、"限制"、"约束"
- "如果...则..."、"当...时..."
- 数值限制（"最多"、"至少"、"范围"）

### 5. 异常场景
关键词识别：
- "异常"、"错误"、"失败"
- "如果不"、"当...无效时"
- "超时"、"中断"、"取消"

### 6. 边界值
识别模式：
- 数值范围（"1-100"、"最大100"）
- 长度限制（"最多50字符"）
- 时间限制（"30分钟内"）
- 数量限制（"最多5次"）

## 测试场景生成规则

### 从验收条件生成
```
验收条件 → 正向测试用例（验证条件满足时的行为）
验收条件取反 → 反向测试用例（验证条件不满足时的处理）
```

### 从边界值生成
```
边界值 N：
- 正好等于 N（边界内）
- N-1（边界内）
- N+1（边界外）
- 0 或空（特殊边界）
```

### 从业务规则生成
```
规则条件 A：
- 满足 A 时的行为
- 不满足 A 时的行为
- A 的边界情况
```

## 示例

**需求原文**：
> 用户注册时需要输入手机号，手机号必须是11位数字且以1开头。
> 如果手机号已被注册，提示"该手机号已注册"。
> 验证码60秒内只能发送一次。

**提取结果**：

| 提取项 | 内容 |
|-------|------|
| 功能 | 用户注册 |
| 输入 | 手机号 |
| 规则1 | 11位数字 |
| 规则2 | 以1开头 |
| 异常1 | 手机号已注册 |
| 限制 | 60秒发送间隔 |

**生成的测试场景**：

| 编号 | 场景 | 类型 | 来源 |
|-----|------|------|------|
| 1 | 输入有效手机号注册成功 | 正向 | 规则1+2 |
| 2 | 输入10位手机号 | 反向 | 规则1边界 |
| 3 | 输入12位手机号 | 反向 | 规则1边界 |
| 4 | 输入非1开头的号码 | 反向 | 规则2 |
| 5 | 输入已注册手机号 | 异常 | 异常1 |
| 6 | 60秒内重复发送验证码 | 边界 | 限制 |
| 7 | 60秒后再次发送验证码 | 边界 | 限制 |

## 场景覆盖检查

生成用例后需检查：
- [ ] 每个验收条件都有对应的正向用例
- [ ] 每个验收条件都有对应的反向用例
- [ ] 每个边界值都有边界测试
- [ ] 每个异常场景都有对应用例
- [ ] 用例可追溯到需求来源

---

# 测试设计方法解析规则

以下规则用于识别需求中适用各种测试设计方法的模式，并自动生成相应用例。

## 等价类划分识别规则

### 识别触发模式

从需求文本中识别以下模式来划分等价类：

| 模式类型 | 关键词/句式 | 等价类划分 |
|---------|------------|-----------|
| **范围限制** | `在...之间`、`范围`、`不超过`、`至少`、`最多`、`N-M` | 有效区间 / 小于下限 / 大于上限 |
| **集合限制** | `仅限`、`只能是`、`可选值包括`、`支持的类型` | 集合内各值 / 集合外值 |
| **格式限制** | `格式`、`符合`、`正则`、`必须为`、`...格式` | 符合格式 / 不符合格式 |
| **必填标记** | `必填`、`必须`、`不能为空`、`required`、`*` | 有效值 / 空值 |
| **长度限制** | `长度`、`字符数`、`位数`、`最短`、`最长` | 有效长度 / 太短 / 太长 |
| **类型限制** | `数字`、`字母`、`中文`、`整数`、`小数` | 正确类型 / 错误类型 |

### 等价类提取示例

**需求原文**：
> 手机号必须是11位数字，以1开头

**解析过程**：
1. 识别「11位数字」→ 长度限制 → 划分：11位(有效) / <11位(无效) / >11位(无效)
2. 识别「数字」→ 类型限制 → 划分：纯数字(有效) / 含字母(无效) / 含特殊字符(无效)
3. 识别「以1开头」→ 格式限制 → 划分：1开头(有效) / 非1开头(无效)

**输出等价类表**：

| 输入项 | 等价类ID | 类型 | 描述 | 测试数据 |
|-------|---------|------|------|---------|
| 手机号 | EC_01 | 有效 | 11位1开头纯数字 | 13812345678 |
| 手机号 | EC_02 | 无效 | 10位数字 | 1381234567 |
| 手机号 | EC_03 | 无效 | 12位数字 | 138123456789 |
| 手机号 | EC_04 | 无效 | 非1开头 | 23812345678 |
| 手机号 | EC_05 | 无效 | 含字母 | 1381234567a |
| 手机号 | EC_06 | 无效 | 空值 | null |

---

## 边界值提取规则

### 识别触发模式

| 边界类型 | 关键词 | 提取方法 |
|---------|--------|---------|
| **数值边界** | `最小`、`最大`、`不超过`、`至少`、`≤`、`≥`、`<`、`>` | 提取数值N，测试N-1, N, N+1 |
| **长度边界** | `长度`、`字符数`、`位数`、`最短M`、`最长N` | 测试M-1, M, N, N+1 |
| **数量边界** | `最多N个`、`至少M条`、`限制N次` | 测试M-1, M, N, N+1 |
| **时间边界** | `N分钟内`、`超过N小时`、`等待N秒` | 测试N-1, N, N+1 (时间单位) |
| **金额边界** | `最低N元`、`上限M`、`满N减` | 测试N-0.01, N, M, M+0.01 |

### 边界值提取示例

**需求原文**：
> 密码长度6-20位，首次登录后24小时内需修改密码

**解析过程**：
1. 识别「6-20位」→ 长度边界 [6, 20]
2. 识别「24小时内」→ 时间边界 ≤24

**输出边界值表**：

| 输入项 | 边界类型 | 测试点 | 测试值 | 预期结果 |
|-------|---------|--------|-------|---------|
| 密码长度 | 下边界-1 | 离点 | 5位 | 失败 |
| 密码长度 | 下边界 | 上点 | 6位 | 成功 |
| 密码长度 | 上边界 | 上点 | 20位 | 成功 |
| 密码长度 | 上边界+1 | 离点 | 21位 | 失败 |
| 修改时间 | 边界内 | 内点 | 23小时 | 正常提醒 |
| 修改时间 | 边界 | 上点 | 24小时 | 强制修改 |
| 修改时间 | 边界外 | 离点 | 25小时 | 锁定账号 |

---

## 场景流识别规则

### 流程类型识别模式

| 流程类型 | 识别关键词/句式 |
|---------|----------------|
| **基本流** | `正常情况`、`成功后`、主语句（无条件分支的陈述句）|
| **备选流** | `也可以`、`或者`、`另外支持`、`如果选择` |
| **异常流** | `如果失败`、`当...无效时`、`错误情况`、`超时`、`异常`、`否则` |

### 条件分支识别

识别条件语句模式：

```
"如果 <条件> 则 <结果A>，否则 <结果B>"
→ 备选流：条件成立时的路径
→ 异常流：条件不成立时的路径

"当 <状态> 时，<行为>"
→ 场景分支

"支持 A / B / C 三种方式"
→ 三条备选流
```

### 场景流提取示例

**需求原文**：
> 用户可以通过账号密码或手机验证码登录。
> 登录成功后跳转首页。
> 如果密码连续错误5次，账号锁定15分钟。
> 验证码60秒内只能获取一次。

**解析过程**：

```
基本流1（账号密码登录）：
  输入账号 → 输入密码 → 点击登录 → 成功 → 跳转首页

基本流2（验证码登录）：
  输入手机号 → 获取验证码 → 输入验证码 → 点击登录 → 成功 → 跳转首页

异常流1（密码错误）：
  基本流1步骤3 → 密码错误 → 提示错误 → 允许重试

异常流2（连续错误锁定）：
  异常流1重复5次 → 账号锁定15分钟 → 提示锁定

异常流3（验证码频率限制）：
  基本流2步骤2 → 60秒内再次获取 → 提示等待
```

**输出场景矩阵**：

| 场景ID | 场景名称 | 类型 | 路径描述 | 优先级 |
|--------|---------|------|---------|--------|
| SC_01 | 账号密码正常登录 | 基本流 | 输入正确账号密码→成功 | P0 |
| SC_02 | 验证码正常登录 | 基本流 | 手机号→验证码→成功 | P0 |
| SC_03 | 密码错误提示 | 异常流 | 错误密码→提示重试 | P1 |
| SC_04 | 账号锁定机制 | 异常流 | 5次错误→锁定15分钟 | P1 |
| SC_05 | 验证码频率控制 | 异常流 | 60秒内重复获取→拒绝 | P1 |

---

## 错误推测触发规则

### 自动触发条件

当需求中出现以下元素时，自动添加错误推测用例：

| 触发元素 | 推测错误类型 | 生成用例 |
|---------|-------------|---------|
| **输入框** | 特殊字符、超长输入、空值 | SQL注入、XSS、空格处理 |
| **提交按钮** | 重复提交、并发 | 快速双击、多窗口操作 |
| **文件上传** | 格式、大小、内容 | 非法格式、超大文件、空文件 |
| **列表/表格** | 边界记录 | 首条、末条、空列表 |
| **搜索功能** | 特殊查询 | 通配符、无结果、大结果集 |
| **金额字段** | 精度问题 | 小数点、负数、0元 |
| **日期时间** | 格式和边界 | 跨天、跨年、时区 |
| **表单提交** | 操作中断 | 网络断开、页面刷新 |

### 输入类型→错误推测映射

| 输入类型 | 推测的异常输入 |
|---------|---------------|
| 文本框 | `' " < > & \ / # @ ! $ %`、空格、超长、null |
| 数值框 | 负数、0、MAX_INT、小数、非数字字符 |
| 手机号 | 非1开头、非11位、非数字、空号段 |
| 邮箱 | 缺少@、多个@、特殊域名、超长 |
| 密码 | 纯数字、纯字母、含空格、常见弱密码 |
| 日期 | 过去日期、未来日期、无效日期(2/30) |
| URL | 非http(s)、恶意链接、过长URL |

### 模块类型→错误推测映射

| 模块类型 | 推测的错误场景 |
|---------|---------------|
| 登录 | 账号不存在、密码错误、账号锁定、会话过期 |
| 注册 | 重复注册、验证码错误、协议未勾选 |
| 支付 | 余额不足、支付超时、重复支付、金额为0 |
| 订单 | 库存不足、并发下单、订单取消后操作 |
| 文件 | 上传失败、下载中断、格式不支持 |
| 权限 | 越权访问、Token过期、角色切换 |

---

## 需求ID提取规则

### 自动识别模式

| 模式名称 | 正则表达式 | 示例匹配 |
|---------|-----------|---------|
| 标准REQ | `REQ[-_]?\d{3,}` | REQ_001, REQ-123 |
| 功能编号 | `F[-_]?\d+(\.\d+)*` | F1.2, F-3.1.2 |
| 用户故事 | `US[-_]?\d{3,}` | US_042, US-001 |
| 章节编号 | `^\d+(\.\d+)+\s+` | 3.2.1 用户登录 |
| JIRA格式 | `[A-Z]{2,}-\d+` | PROJ-123, BUG-456 |
| 中文编号 | `需求\d+` | 需求001 |

### 需求ID生成规则

如果需求文档中没有明确的需求ID，按以下规则自动生成：

```
格式：MOD_{模块缩写}_{序号}

示例：
- 登录模块第1个需求：MOD_LOGIN_001
- 订单模块第3个需求：MOD_ORDER_003
- 用户管理模块：MOD_USER_001

模块缩写映射：
- 登录/注册 → LOGIN
- 用户/个人中心 → USER
- 订单 → ORDER
- 支付 → PAY
- 商品/产品 → PRODUCT
- 购物车 → CART
- 搜索 → SEARCH
- 消息/通知 → MSG
- 设置/配置 → CONFIG
```

---

## 综合解析流程

Claude 解析需求文档时应按以下顺序执行：

```
1. 结构识别
   - 识别文档格式（PRD/用户故事/功能说明）
   - 提取模块/功能层级

2. 需求ID提取
   - 自动识别或生成需求ID
   - 建立需求列表

3. 等价类划分
   - 扫描所有输入项
   - 识别范围/集合/格式/必填限制
   - 生成等价类表

4. 边界值提取
   - 扫描数值、长度、时间限制
   - 提取边界点

5. 场景流识别
   - 识别基本流（主路径）
   - 识别备选流（条件分支）
   - 识别异常流（错误处理）

6. 错误推测补充
   - 根据输入类型触发推测
   - 根据模块类型触发推测
   - 补充安全性测试点

7. 用例生成
   - 整合所有测试点
   - 分配优先级
   - 关联需求ID
   - 标记设计方法

8. 歧义检测
   - 扫描模糊词汇
   - 检测规则冲突
   - 识别缺失信息
   - 标记待确认项
```

---

# 歧义检测规则

当解析需求文档时，Claude 应主动识别以下歧义模式，并使用 AskUserQuestion 询问用户澄清。

## 歧义类型定义

| 类型代码 | 类型名称 | 影响级别 | 处理优先级 |
|---------|---------|---------|-----------|
| `BOUNDARY_UNCLEAR` | 边界不明确 | 高 | P0/P1 |
| `RULE_CONFLICT` | 规则冲突 | 高 | P0/P1 |
| `MISSING_ERROR` | 缺少错误处理 | 中 | P1/P2 |
| `VAGUE_CRITERIA` | 模糊验收标准 | 中 | P1/P2 |
| `INCOMPLETE_FLOW` | 流程不完整 | 中 | P1/P2 |
| `UNDEFINED_TERM` | 未定义术语 | 低 | P2/P3 |

## 检测模式详解

### 1. 边界不明确 (BOUNDARY_UNCLEAR)

**检测关键词**：
- 模糊限定：`适当`、`合理`、`一定`、`足够`、`若干`
- 主观判断：`较多`、`较少`、`基本`、`大概`
- 缺少数值：`多个`、`几次`、`一段时间`

**检测规则**：
```
IF 需求描述包含限定词 AND 无具体数值
THEN 标记为 BOUNDARY_UNCLEAR
```

**示例**：
| 原文 | 歧义点 | 询问方向 |
|------|--------|---------|
| "密码应有足够的复杂度" | "足够"无定义 | 询问具体规则（长度、字符类型） |
| "系统应在合理时间内响应" | "合理时间"无定义 | 询问具体秒数 |
| "用户可输入多个标签" | "多个"无上限 | 询问最大数量 |

**AskUserQuestion 模板**：
```yaml
question: "需求中提到'{keyword}'，但未给出具体数值，请帮助明确"
options:
  - label: "指定具体值: {suggested_value}"
  - label: "使用行业标准"
  - label: "跳过，使用默认规则"
```

---

### 2. 规则冲突 (RULE_CONFLICT)

**检测模式**：
- 同一字段有多个互斥规则
- 前后文描述矛盾
- 验收条件与业务规则冲突

**检测规则**：
```
IF 规则A 约束字段X 为条件C1
AND 规则B 约束字段X 为条件C2
AND C1 与 C2 互斥
THEN 标记为 RULE_CONFLICT
```

**示例**：
| 规则A | 规则B | 冲突点 |
|-------|-------|--------|
| "密码必须包含特殊字符" | "密码只能包含字母和数字" | 特殊字符要求矛盾 |
| "用户年龄必须≥18岁" | "12岁以下用户需家长陪同" | 年龄下限矛盾 |
| "订单金额自动四舍五入" | "订单金额精确到分" | 精度处理矛盾 |

**AskUserQuestion 模板**：
```yaml
question: "检测到规则冲突，请确认哪个优先"
options:
  - label: "采用规则A: {rule_a_description}"
  - label: "采用规则B: {rule_b_description}"
  - label: "两者都需要，我来解释"
  - label: "标记为待确认"
```

---

### 3. 缺少错误处理 (MISSING_ERROR)

**检测模式**：
- 有操作描述但无失败说明
- 有条件判断但无"否则"分支
- 涉及外部系统但无超时处理

**检测关键词缺失**：
- 无 `失败时`、`错误时`、`异常情况`
- 无 `否则`、`不满足时`
- 无 `超时`、`中断`、`取消`

**示例**：
| 原文 | 缺失的错误处理 |
|------|---------------|
| "用户输入密码后验证身份" | 密码错误时的处理 |
| "系统调用支付接口完成扣款" | 支付失败/超时处理 |
| "点击保存按钮提交数据" | 提交失败/网络异常处理 |

**AskUserQuestion 模板**：
```yaml
question: "需求未说明'{operation}'失败时的处理方式"
options:
  - label: "显示错误提示并允许重试"
  - label: "自动回退到上一步"
  - label: "记录日志并通知管理员"
  - label: "我来补充具体逻辑"
```

---

### 4. 模糊验收标准 (VAGUE_CRITERIA)

**检测关键词**：
- 主观描述：`正常显示`、`正确处理`、`友好提示`
- 无法量化：`美观`、`流畅`、`易用`
- 缺乏细节：`等功能`、`等信息`、`相关数据`

**示例**：
| 原文 | 模糊点 | 询问方向 |
|------|--------|---------|
| "登录成功后正常显示首页" | "正常显示"的定义 | 询问具体展示元素 |
| "系统给出友好提示" | "友好提示"的内容 | 询问具体文案 |
| "加载完成后流畅切换" | "流畅"的标准 | 询问具体时间要求 |

**AskUserQuestion 模板**：
```yaml
question: "'{vague_term}'的具体标准是什么？"
options:
  - label: "我来提供具体描述"
  - label: "使用通用标准"
  - label: "生成时添加待确认标记"
```

---

### 5. 流程不完整 (INCOMPLETE_FLOW)

**检测模式**：
- 有开始无结束
- 有条件无后续
- 步骤间有明显跳跃

**示例**：
| 原文 | 缺失环节 |
|------|---------|
| "用户选择商品后..." | 后续步骤未说明 |
| "如果库存不足" | 无后续处理 |
| "提交表单 → 显示结果" | 缺少验证/处理步骤 |

**AskUserQuestion 模板**：
```yaml
question: "流程在'{incomplete_point}'处不完整，请补充后续步骤"
options:
  - label: "我来补充完整流程"
  - label: "参考类似功能处理"
  - label: "标记为待设计"
```

---

### 6. 未定义术语 (UNDEFINED_TERM)

**检测模式**：
- 首次出现的专业词汇
- 缩写无解释
- 项目特有名词

**AskUserQuestion 模板**：
```yaml
question: "术语'{term}'在文档中首次出现，是否需要添加到术语库？"
options:
  - label: "是，含义是: {user_input}"
  - label: "是通用术语，不需解释"
  - label: "忽略此术语"
```

---

## 歧义处理流程

### Quick 模式

```
1. 仅检测 BOUNDARY_UNCLEAR 和 RULE_CONFLICT（高影响级别）
2. 其他歧义自动采用 Claude 理解，标记备注
3. 在生成结果中显示：⚠️ 以下用例基于假设生成
```

### Expert 模式

```
1. 检测所有歧义类型
2. 按优先级排序（P0/P1 歧义优先）
3. 逐一询问用户
4. 记录用户决策到 .memory
5. 下次遇到相似情况可参考历史
```

---

## 歧义检测输出格式

检测完成后，生成歧义报告：

```markdown
## 歧义检测报告

检测到 **{total_count}** 处歧义：

### 高优先级（需立即确认）
| # | 类型 | 原文摘要 | Claude理解 |
|---|------|---------|-----------|
| 1 | BOUNDARY_UNCLEAR | "足够的复杂度" | 密码长度≥8，含大小写字母和数字 |
| 2 | RULE_CONFLICT | 特殊字符规则冲突 | 待用户确认 |

### 中优先级
| # | 类型 | 原文摘要 | Claude理解 |
|---|------|---------|-----------|
| 3 | MISSING_ERROR | 支付失败未说明 | 显示错误并允许重试 |

### 低优先级（已自动处理）
- UNDEFINED_TERM: "SKU" → 已添加到术语库
```

---

## 歧义记忆

将歧义处理决策存入 `.memory/ambiguity-decisions.json`：

```json
{
  "decisions": [
    {
      "date": "2024-01-15",
      "type": "BOUNDARY_UNCLEAR",
      "context": "密码复杂度",
      "user_decision": "长度8-20位，必须包含字母和数字",
      "applied_to": ["REQ_001", "REQ_015"]
    }
  ]
}
```

后续遇到类似歧义时，可引用历史决策。
